<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos de Wallapop</title>
    <style>
        /* Estilos para la tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .productos-container {
            display: none;  /* Oculto inicialmente */
        }
        .center-text {
            text-align: center;
        }
        .loading {
            font-size: 24px;
        }
/* Estilo para la cabecera de la columna "Nombre" */
th:first-child {
    width: 400px;  /* Establece un ancho m√°s estrecho para la cabecera de "Nombre" */
    text-align: left; /* Asegura que el texto est√© alineado a la izquierda */
}
       /* Estilo para la celda que contiene el nombre y las flechas */
td:first-child {
    display: flex;
    width: 400px;
    align-items: center; /* Alinea verticalmente el contenido */
    justify-content: space-between; /* Distribuye espacio entre el texto y las flechas */
}
/* Estilo para la cabecera de la columna "URL" */
th:nth-child(2) {
    width: 130px;  /* Establece un ancho m√°s estrecho para la cabecera de la columna "URL" */
    text-align: left; /* Asegura que el texto est√© alineado a la izquierda */
}

/* Estilo para las celdas de la columna "URL" */
td:nth-child(2) {
    width: 130px;  /* Establece el mismo ancho para las celdas de la columna "URL" */
    word-wrap: break-word; /* Asegura que el texto largo en la URL se ajuste a la celda */
}
/* Estilo para la cabecera de la columna "Actualizar" */
th:nth-child(3) {
    width: 80px;  /* Establece un ancho m√°s estrecho para la cabecera de la columna "Actualizar" */
    text-align: center; /* Alinea el texto de la cabecera en el centro */
}

/* Estilo para las celdas de la columna "Actualizar" */
td:nth-child(3) {
    width: 80px;  /* Establece el mismo ancho para las celdas de la columna "Actualizar" */
    text-align: center; /* Alinea el contenido de las celdas en el centro */
}
/* Alineaci√≥n para la primera columna "Nombre" - No cambia */
td:first-child,
th:first-child {
    text-align: left;  /* Deja la primera columna alineada a la izquierda */
}

/* Alineaci√≥n para la segunda columna "URL" - No cambia */
td:nth-child(2),
th:nth-child(2) {
    text-align: left;  /* Deja la segunda columna alineada a la izquierda */
}

/* Alineaci√≥n centrada para las dem√°s columnas */
td:nth-child(n+3),
th:nth-child(n+3) {
    text-align: center;  /* Alinea al centro todas las columnas excepto la 1¬™ y 2¬™ */
}

/* Estilo para el campo de texto */
td:first-child input[type="text"] {
    resize: horizontal;
    width: 310px; /* Ancho del campo de texto */
    padding: 5px;
}

/* Contenedor de las flechas */
.flechas {
    display: flex;
    align-items: center; /* Alinea las flechas verticalmente */
    justify-content: center; /* Alinea las flechas horizontalmente */
    cursor: pointer;
    font-size: 18px;
    color: rgba(0, 0, 0, 0.5); /* Flechas m√°s sutiles */
    padding: 0 10px;
}

/* Espacio entre las flechas */
.flecha {
    margin: 0 5px; /* A√±ade espacio entre las flechas */
}

    </style>
</head>
<body>
    <h1>Lista de Productos de Wallapop</h1>

    <!-- Tabla para manejar los productos -->
    <table>
        <thead>
            <tr>
                <th>Nombre</th>
                <th>URL</th>
                <th>Actualizar</th>
                <th>Precio medio</th>
                <th>Precio m√≠nimo</th>
                <th>Enlaces</th>
                <th>Guardar</th>
                <th>Editar</th>  <!-- Nueva columna para "Editar" -->
                <th>Eliminar</th>  <!-- Nueva columna para "Eliminar" -->
            </tr>
        </thead>
        <tbody id="tabla-productos">
            <!-- Aqu√≠ se agregar√°n las filas din√°micamente -->
        </tbody>
    </table>

    <button onclick="agregarFila()">A√±adir fila</button>

    <script>
        window.onload = cargarProductos;
    
        function cargarProductos() {
    const productosGuardados = JSON.parse(localStorage.getItem('productos')) || [];
    productosGuardados.forEach(producto => {
        const tabla = document.getElementById('tabla-productos');
        const nuevaFila = document.createElement('tr');

        nuevaFila.innerHTML = `
    <td>
        <input type="text" value="${producto.nombre}" disabled>
        <div class="flechas" style="text-align: right;">
            <span class="flecha" onclick="moverArriba(this)">‚Üë</span>
            <span class="flecha" onclick="moverAbajo(this)">‚Üì</span>
        </div>
    </td>
    <td><input type="text" value="${producto.url}" disabled></td>
    <td><button onclick="actualizarProductos(this)" disabled>üîÑÔ∏è</button></td>
    <td><div class="center-text loading">${producto.precioMedio}</div></td>
    <td><div class="center-text loading">${producto.precioMinimo}</div></td>
    <td><a href="javascript:void(0)" onclick="toggleProductos(this)">üñáÔ∏è Productos</a>
        <div class="productos-container">${producto.productosHtml}</div>
    </td>
    <td><button class="guardar-btn" onclick="guardarCambios(this)" disabled>üíæ</button></td>
    <td><button onclick="editarFila(this)">‚úèÔ∏è</button></td>
    <td><button onclick="eliminarFila(this)">‚ùå</button></td>
`;



        tabla.appendChild(nuevaFila);
        nuevaFila.productos = producto.productos;

        // Ocultar los botones "üö´" inicialmente
        const eliminarProductoBtns = nuevaFila.querySelectorAll('.eliminar-producto');
        eliminarProductoBtns.forEach(btn => btn.style.display = 'none');
    });
};
        
    
        function agregarFila() {
            const tabla = document.getElementById('tabla-productos');
            const nuevaFila = document.createElement('tr');
    
            nuevaFila.innerHTML = `
                <td><input type="text" placeholder="Nombre del producto"></td>
                <td><input type="text" placeholder="URL de b√∫squeda"></td>
                <td><button onclick="actualizarProductos(this)">üîÑÔ∏è</button></td>
                <td><div class="center-text loading">‚è≥</div></td>
                <td><div class="center-text loading">‚è≥</div></td>
                <td><a href="javascript:void(0)" onclick="toggleProductos(this)">üñáÔ∏è Productos</a>
                    <div class="productos-container"></div>
                </td>
                <td><button class="guardar-btn" onclick="guardarFila(this)">üíæ</button></td>
                <td><button onclick="editarFila(this)">‚úèÔ∏è</button></td>
                <td><button onclick="eliminarFila(this)">‚ùå</button></td>
            `;
            tabla.appendChild(nuevaFila);
        }
    
        function actualizarProductos(boton) {
    const fila = boton.closest('tr');
    const urlInput = fila.cells[1].querySelector('input');
    const productosContainer = fila.querySelector('.productos-container');
    const precioMedioCol = fila.cells[3].querySelector('.loading');
    const precioMinimoCol = fila.cells[4].querySelector('.loading');
    const url = urlInput.value.trim();

    // Si no se ingresa una URL, se detiene la ejecuci√≥n
    if (!url) {
        alert("Por favor, ingresa una URL v√°lida.");
        return;
    }

    // Muestra un estado de carga
    precioMedioCol.innerText = '‚è≥';
    precioMinimoCol.innerText = '‚è≥';

    // Realiza la solicitud para obtener los precios
    fetch(`http://localhost:3000/obtener-precios?url=${encodeURIComponent(url)}`)
        .then(response => {
            console.log('Respuesta de la API:', response); // Para depuraci√≥n
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos de la API:', data); // Verifica que los datos lleguen correctamente

            if (data.length === 0) {
                productosContainer.innerHTML = 'No se encontraron productos.';
                precioMedioCol.innerText = 'No disponible';
                precioMinimoCol.innerText = 'No disponible';
                return;
            }

            // Array para almacenar los precios
            let precios = [];
            data.forEach(producto => {
                const precioNum = parseFloat(producto.precio.replace('‚Ç¨', '').replace(',', '.'));
                precios.push(precioNum);
            });

            // Calcula el precio m√≠nimo y medio
            const precioMinimo = Math.min(...precios);
            const precioMedio = (Math.max(...precios) + precioMinimo) / 2;

            // Ordena los productos por precio
            data.sort((a, b) => {
                const precioA = parseFloat(a.precio.replace('‚Ç¨', '').replace(',', '.'));
                const precioB = parseFloat(b.precio.replace('‚Ç¨', '').replace(',', '.'));
                return precioA - precioB;
            });

            // Genera el HTML de los productos
            let productosHtml = '';
            data.forEach((producto, index) => {
                const precioNum = parseFloat(producto.precio.replace('‚Ç¨', '').replace(',', '.'));
                const emoji = precioNum > precioMedio ? 'üî¥' : 'üü¢';

                productosHtml += `
                    <div class="producto">
                        <div class="precio">
                            ${emoji} 
                            <a href="${producto.enlace}" target="_blank">${producto.precio}</a>
                            <span class="eliminar-producto" onclick="eliminarProducto(${index}, this)"> üö´</span>
                        </div>
                    </div>
                `;
            });

            // Actualiza la vista de los productos y los precios
            productosContainer.innerHTML = productosHtml;
            precioMedioCol.innerText = `${precioMedio.toFixed(2)} ‚Ç¨`;
            precioMinimoCol.innerText = `${precioMinimo.toFixed(2)} ‚Ç¨`;

            // Asigna los productos a la fila
            fila.productos = data;
        })
        .catch(error => {
            console.error('Error al obtener los productos:', error);
            alert('Hubo un problema al obtener los productos.');
            precioMedioCol.innerText = 'Error';
            precioMinimoCol.innerText = 'Error';
        });
}

    
        function toggleProductos(enlace) {
            const productosContainer = enlace.closest('td').querySelector('.productos-container');
            productosContainer.style.display = productosContainer.style.display === 'block' ? 'none' : 'block';
        }
    
function guardarFila(boton) {
    const fila = boton.closest('tr');
    const nombre = fila.cells[0].querySelector('input').value;
    const url = fila.cells[1].querySelector('input').value;
    const precioMedio = fila.cells[3].querySelector('.loading').innerText;
    const precioMinimo = fila.cells[4].querySelector('.loading').innerText;
    const productosContainer = fila.querySelector('.productos-container');

    if (!nombre || !url || !precioMedio || !precioMinimo || !fila.productos) {
        alert("Por favor, completa todos los campos antes de guardar.");
        return;
    }

    const productoGuardado = {
        nombre,
        url,
        precioMedio,
        precioMinimo,
        productos: fila.productos,
        productosHtml: productosContainer.innerHTML
    };

    let productosGuardados = JSON.parse(localStorage.getItem('productos')) || [];

    const index = productosGuardados.findIndex(p => p.nombre === nombre);
    if (index >= 0) {
        productosGuardados[index] = productoGuardado;
    } else {
        productosGuardados.push(productoGuardado);
    }

    localStorage.setItem('productos', JSON.stringify(productosGuardados));

    // Desactivar inputs y botones de edici√≥n
    fila.cells[0].querySelector('input').disabled = true;
    fila.cells[1].querySelector('input').disabled = true;
    fila.cells[2].querySelector('button').disabled = true;
    boton.disabled = true;
    fila.cells[7].querySelector('button').disabled = false; // Reactivar ‚úèÔ∏è

    // Ocultar los botones "üö´" despu√©s de guardar
    const eliminarProductoBtns = fila.querySelectorAll('.eliminar-producto');
    eliminarProductoBtns.forEach(btn => btn.style.display = 'none');
}
    
        function guardarCambios(boton) {
            guardarFila(boton);
        }
    
        function eliminarFila(boton) {
            const fila = boton.closest('tr');
            const nombreProducto = fila.cells[0].querySelector('input').value;
    
            fila.remove();
    
            let productosGuardados = JSON.parse(localStorage.getItem('productos')) || [];
            productosGuardados = productosGuardados.filter(producto => producto.nombre !== nombreProducto);
            localStorage.setItem('productos', JSON.stringify(productosGuardados));
        }
    
        function editarFila(boton) {
    const fila = boton.closest('tr');
    const nombreInput = fila.cells[0].querySelector('input');
    const urlInput = fila.cells[1].querySelector('input');
    const actualizarBoton = fila.cells[2].querySelector('button');
    const guardarBoton = fila.cells[6].querySelector('button');
    const eliminarProductoBtns = fila.querySelectorAll('.eliminar-producto');

    // Habilitar los inputs
    nombreInput.disabled = false;
    urlInput.disabled = false;
    actualizarBoton.disabled = false;
    guardarBoton.disabled = false;

    // Mostrar los botones "üö´"
    eliminarProductoBtns.forEach(btn => btn.style.display = 'inline-block');

    // Desactivar el bot√≥n ‚úèÔ∏è mientras se edita
    boton.disabled = true;
}

            
        function eliminarProducto(index, elemento) {
    // Obt√©n el producto desde la fila
    const fila = elemento.closest('tr');
    const productos = fila.productos;

    // Eliminar el producto de la lista
    productos.splice(index, 1);

    // Recalcular precios m√≠nimos y medios
    recalcularPrecios(fila);

    // Actualizar los productos en la fila
    const productosContainer = fila.querySelector('.productos-container');
    fila.productos = productos;

    // Volver a mostrar los productos actualizados
    let productosHtml = '';
    productos.forEach((producto, index) => {
        const precioNum = parseFloat(producto.precio.replace('‚Ç¨', '').replace(',', '.'));
        const emoji = precioNum > parseFloat(fila.cells[3].querySelector('.loading').innerText.replace(' ‚Ç¨', '')) ? 'üî¥' : 'üü¢';
        productosHtml += `
            <div class="producto">
                <div class="precio">
                    ${emoji} 
                    <a href="${producto.enlace}" target="_blank">${producto.precio}</a>
                    <span class="eliminar-producto" onclick="eliminarProducto(${index}, this)"> üö´</span>
                </div>
            </div>
        `;
    });

    productosContainer.innerHTML = productosHtml;

    // Actualizar la lista guardada
    let productosGuardados = JSON.parse(localStorage.getItem('productos')) || [];
    const nombreProducto = fila.cells[0].querySelector('input').value;
    const indexGuardado = productosGuardados.findIndex(p => p.nombre === nombreProducto);

    if (indexGuardado >= 0) {
        productosGuardados[indexGuardado].productos = productos;
        productosGuardados[indexGuardado].productosHtml = productosContainer.innerHTML;
        localStorage.setItem('productos', JSON.stringify(productosGuardados));
    }
}

function recalcularPrecios(fila) {
    const productos = fila.productos;
    const precioMedioCol = fila.cells[3].querySelector('.loading');
    const precioMinimoCol = fila.cells[4].querySelector('.loading');

    if (productos.length === 0) {
        precioMedioCol.innerText = 'No disponible';
        precioMinimoCol.innerText = 'No disponible';
        return;
    }

    let precios = productos.map(producto => parseFloat(producto.precio.replace('‚Ç¨', '').replace(',', '.')));
    const precioMinimo = Math.min(...precios);
    const precioMedio = (Math.max(...precios) + precioMinimo) / 2;

    // Actualizar los valores en la tabla
    precioMedioCol.innerText = `${precioMedio.toFixed(2)} ‚Ç¨`;
    precioMinimoCol.innerText = `${precioMinimo.toFixed(2)} ‚Ç¨`;
}

// Funci√≥n para mover una fila hacia arriba
function moverArriba(flecha) {
    const fila = flecha.closest('tr');  // Obtiene la fila de la flecha
    const tabla = fila.closest('tbody');  // Obtiene el contenedor de la tabla (tbody)
    const filaAnterior = fila.previousElementSibling;  // Encuentra la fila anterior

    if (filaAnterior) {
        tabla.insertBefore(fila, filaAnterior);  // Mueve la fila hacia arriba
        guardarCambioPosicion();  // Guarda el cambio en localStorage
    }
}

// Funci√≥n para mover una fila hacia abajo
function moverAbajo(flecha) {
    const fila = flecha.closest('tr');  // Obtiene la fila de la flecha
    const tabla = fila.closest('tbody');  // Obtiene el contenedor de la tabla (tbody)
    const filaSiguiente = fila.nextElementSibling;  // Encuentra la fila siguiente

    if (filaSiguiente) {
        tabla.insertBefore(filaSiguiente, fila);  // Mueve la fila hacia abajo
        guardarCambioPosicion();  // Guarda el cambio en localStorage
    }
}

// Funci√≥n para guardar el cambio de posici√≥n de las filas
function guardarCambioPosicion() {
    const tabla = document.getElementById('tabla-productos');
    const filas = Array.from(tabla.querySelectorAll('tr'));
    const productos = filas.map(fila => {
        return {
            nombre: fila.cells[0].querySelector('input').value,
            url: fila.cells[1].querySelector('input').value,
            precioMedio: fila.cells[3].querySelector('.loading').innerText,
            precioMinimo: fila.cells[4].querySelector('.loading').innerText,
            productosHtml: fila.querySelector('.productos-container').innerHTML
        };
    });
    localStorage.setItem('productos', JSON.stringify(productos));  // Guarda el nuevo orden
}


    </script>
    
</body>
</html>
